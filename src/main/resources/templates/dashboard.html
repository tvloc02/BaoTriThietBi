<!DOCTYPE html>
<html>
<head>
    <title>üîç Debug Dashboard Access</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-btn { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .test-btn:hover { background: #0056b3; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; width: 200px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status.ok { background: #28a745; color: white; }
        .status.fail { background: #dc3545; color: white; }
        .status.pending { background: #ffc107; color: black; }
    </style>
</head>
<body>
<div class="container">
    <h1>üîç Debug Dashboard Access - Complete Flow</h1>

    <div class="section">
        <h3>üìä System Status</h3>
        <div id="systemStatus">
            <span class="status pending">Checking...</span>
        </div>
    </div>

    <div class="grid">
        <div class="section">
            <h3>üîó 1. API Tests</h3>
            <button class="test-btn" onclick="testAPIConnection()">Test API Connection</button>
            <button class="test-btn" onclick="testDatabaseConnection()">Test Database</button>
            <div id="apiResults" class="result"></div>
        </div>

        <div class="section">
            <h3>üîê 2. Authentication Test</h3>
            <input type="text" id="username" value="admin" placeholder="Username">
            <input type="password" id="password" value="123456" placeholder="Password"><br>
            <button class="test-btn" onclick="testLogin()">Test Login API</button>
            <button class="test-btn" onclick="testFormLogin()">Test Form Login</button>
            <div id="authResults" class="result"></div>
        </div>
    </div>

    <div class="section">
        <h3>üè† 3. Dashboard Access Tests</h3>
        <button class="test-btn" onclick="testDashboardDirect()">Direct Dashboard Access</button>
        <button class="test-btn" onclick="testDashboardWithToken()">Dashboard with Token</button>
        <button class="test-btn" onclick="testDashboardRedirect()">Test Auto Redirect</button>
        <div id="dashboardResults" class="result"></div>
    </div>

    <div class="section">
        <h3>üõ†Ô∏è 4. Fix Attempts</h3>
        <button class="test-btn" onclick="createTestUser()">Create Test User</button>
        <button class="test-btn" onclick="clearAllData()">Clear All Data</button>
        <button class="test-btn" onclick="simulateFormLogin()">Simulate Form Login</button>
        <div id="fixResults" class="result"></div>
    </div>

    <div class="section">
        <h3>üìã 5. Current State</h3>
        <button class="test-btn" onclick="showCurrentState()">Show Current State</button>
        <div id="stateResults" class="result"></div>
    </div>

    <div class="section">
        <h3>üöÄ 6. Quick Actions</h3>
        <button class="test-btn" onclick="runFullDiagnostic()">Run Full Diagnostic</button>
        <button class="test-btn" onclick="window.open('/login', '_blank')">Open Login Page</button>
        <button class="test-btn" onclick="window.open('/dashboard', '_blank')">Try Dashboard</button>
    </div>
</div>

<script>
    const API_BASE = window.location.origin + '/api';

    function log(message, type = 'info', elementId = null) {
        console.log(message);
        if (elementId) {
            const element = document.getElementById(elementId);
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            element.appendChild(div);
            element.scrollTop = element.scrollHeight;
        }
    }

    function clearResults(elementId) {
        document.getElementById(elementId).innerHTML = '';
    }

    async function testAPIConnection() {
        clearResults('apiResults');
        log('Testing API connection...', 'info', 'apiResults');

        try {
            const response = await fetch(`${API_BASE}/auth/test`);
            if (response.ok) {
                const data = await response.json();
                log(`‚úÖ API OK: ${JSON.stringify(data)}`, 'success', 'apiResults');
                return true;
            } else {
                log(`‚ùå API Failed: ${response.status}`, 'error', 'apiResults');
                return false;
            }
        } catch (error) {
            log(`üí• API Error: ${error.message}`, 'error', 'apiResults');
            return false;
        }
    }

    async function testDatabaseConnection() {
        log('Testing database connection...', 'info', 'apiResults');

        try {
            const response = await fetch(`${API_BASE}/debug/test-database`);
            if (response.ok) {
                const data = await response.json();
                log(`‚úÖ Database OK: ${data.totalUsers} users found`, 'success', 'apiResults');
                return true;
            } else {
                log(`‚ùå Database Failed: ${response.status}`, 'error', 'apiResults');
                return false;
            }
        } catch (error) {
            log(`üí• Database Error: ${error.message}`, 'error', 'apiResults');
            return false;
        }
    }

    async function testLogin() {
        clearResults('authResults');
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        log(`Testing login API for: ${username}`, 'info', 'authResults');

        try {
            const response = await fetch(`${API_BASE}/auth/dang-nhap`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    tenDangNhap: username,
                    matKhau: password
                })
            });

            const responseText = await response.text();
            log(`Response: ${responseText}`, 'info', 'authResults');

            if (response.ok) {
                const data = JSON.parse(responseText);
                if (data.success) {
                    log('‚úÖ Login API Success!', 'success', 'authResults');

                    // Save token
                    if (data.token) {
                        localStorage.setItem('token', data.token);
                        log('üíæ Token saved to localStorage', 'success', 'authResults');
                    }

                    return data;
                } else {
                    log(`‚ùå Login failed: ${data.message}`, 'error', 'authResults');
                    return null;
                }
            } else {
                log(`‚ùå Login request failed: ${response.status}`, 'error', 'authResults');
                return null;
            }
        } catch (error) {
            log(`üí• Login error: ${error.message}`, 'error', 'authResults');
            return null;
        }
    }

    async function testFormLogin() {
        log('Testing form-based login...', 'info', 'authResults');

        try {
            // Create a hidden form for form-based login
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/perform-login';
            form.style.display = 'none';
            form.target = '_blank';

            const usernameInput = document.createElement('input');
            usernameInput.name = 'username';
            usernameInput.value = document.getElementById('username').value;
            form.appendChild(usernameInput);

            const passwordInput = document.createElement('input');
            passwordInput.name = 'password';
            passwordInput.value = document.getElementById('password').value;
            form.appendChild(passwordInput);

            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);

            log('‚úÖ Form login submitted - check new tab', 'success', 'authResults');
        } catch (error) {
            log(`üí• Form login error: ${error.message}`, 'error', 'authResults');
        }
    }

    async function testDashboardDirect() {
        clearResults('dashboardResults');
        log('Testing direct dashboard access...', 'info', 'dashboardResults');

        try {
            const response = await fetch('/dashboard', {
                method: 'GET',
                credentials: 'same-origin'
            });

            log(`Dashboard response: ${response.status} ${response.statusText}`, 'info', 'dashboardResults');

            if (response.ok) {
                log('‚úÖ Dashboard accessible', 'success', 'dashboardResults');
                return true;
            } else if (response.status === 302 || response.status === 301) {
                const location = response.headers.get('Location');
                log(`üîÑ Dashboard redirected to: ${location}`, 'warning', 'dashboardResults');
                return false;
            } else {
                log(`‚ùå Dashboard access denied: ${response.status}`, 'error', 'dashboardResults');
                return false;
            }
        } catch (error) {
            log(`üí• Dashboard error: ${error.message}`, 'error', 'dashboardResults');
            return false;
        }
    }

    async function testDashboardWithToken() {
        log('Testing dashboard with stored token...', 'info', 'dashboardResults');

        const token = localStorage.getItem('token');
        if (!token) {
            log('‚ùå No token found in localStorage', 'error', 'dashboardResults');
            return false;
        }

        try {
            const response = await fetch('/dashboard', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                credentials: 'same-origin'
            });

            if (response.ok) {
                log('‚úÖ Dashboard accessible with token', 'success', 'dashboardResults');
                return true;
            } else {
                log(`‚ùå Dashboard denied even with token: ${response.status}`, 'error', 'dashboardResults');
                return false;
            }
        } catch (error) {
            log(`üí• Token dashboard error: ${error.message}`, 'error', 'dashboardResults');
            return false;
        }
    }

    function testDashboardRedirect() {
        log('Testing dashboard redirect in new tab...', 'info', 'dashboardResults');
        window.open('/dashboard', '_blank');
        log('‚úÖ Dashboard opened in new tab - check manually', 'success', 'dashboardResults');
    }

    async function createTestUser() {
        clearResults('fixResults');
        log('Creating test user...', 'info', 'fixResults');

        try {
            const response = await fetch(`${API_BASE}/debug/create-test-user`, {
                method: 'POST'
            });

            if (response.ok) {
                const data = await response.json();
                log(`‚úÖ ${data.message}`, 'success', 'fixResults');
            } else {
                log(`‚ùå Create user failed: ${response.status}`, 'error', 'fixResults');
            }
        } catch (error) {
            log(`üí• Create user error: ${error.message}`, 'error', 'fixResults');
        }
    }

    function clearAllData() {
        localStorage.clear();
        sessionStorage.clear();
        log('üóëÔ∏è All browser data cleared', 'info', 'fixResults');
    }

    async function simulateFormLogin() {
        log('Simulating form login with redirect...', 'info', 'fixResults');

        // First login via API
        const loginResult = await testLogin();

        if (loginResult && loginResult.success) {
            log('API login successful, now redirecting...', 'success', 'fixResults');

            // Wait a bit then redirect
            setTimeout(() => {
                log('Redirecting to dashboard...', 'info', 'fixResults');
                window.location.href = '/dashboard';
            }, 1000);
        } else {
            log('‚ùå Cannot simulate - API login failed', 'error', 'fixResults');
        }
    }

    function showCurrentState() {
        clearResults('stateResults');

        const token = localStorage.getItem('token');
        const userData = localStorage.getItem('nguoiDung');
        const currentUrl = window.location.href;

        log(`Current URL: ${currentUrl}`, 'info', 'stateResults');
        log(`Token in localStorage: ${token ? 'YES' : 'NO'}`, token ? 'success' : 'error', 'stateResults');
        log(`User data in localStorage: ${userData ? 'YES' : 'NO'}`, userData ? 'success' : 'error', 'stateResults');

        if (token) {
            log(`Token preview: ${token.substring(0, 50)}...`, 'info', 'stateResults');
        }

        if (userData) {
            try {
                const user = JSON.parse(userData);
                log(`User: ${user.tenDangNhap || 'unknown'}`, 'info', 'stateResults');
            } catch (e) {
                log('‚ùå Invalid user data in localStorage', 'error', 'stateResults');
            }
        }
    }

    async function runFullDiagnostic() {
        document.getElementById('systemStatus').innerHTML = '<span class="status pending">Running diagnostic...</span>';

        // Clear all results
        ['apiResults', 'authResults', 'dashboardResults', 'fixResults', 'stateResults'].forEach(clearResults);

        let allPassed = true;

        // Step 1: API
        log('=== STEP 1: API CONNECTION ===', 'info', 'apiResults');
        const apiOk = await testAPIConnection();
        const dbOk = await testDatabaseConnection();

        if (!apiOk || !dbOk) {
            allPassed = false;
            log('‚ùå Basic connectivity failed', 'error', 'apiResults');
        }

        // Step 2: Auth
        log('=== STEP 2: AUTHENTICATION ===', 'info', 'authResults');
        const loginResult = await testLogin();

        if (!loginResult) {
            allPassed = false;
            log('‚ùå Authentication failed', 'error', 'authResults');
        }

        // Step 3: Dashboard
        log('=== STEP 3: DASHBOARD ACCESS ===', 'info', 'dashboardResults');
        const dashboardOk = await testDashboardDirect();

        if (!dashboardOk) {
            allPassed = false;
            log('‚ùå Dashboard access failed', 'error', 'dashboardResults');
        }

        // Final status
        const statusElement = document.getElementById('systemStatus');
        if (allPassed) {
            statusElement.innerHTML = '<span class="status ok">All systems OK</span>';
            log('üéâ All tests passed! Try logging in now.', 'success', 'fixResults');
        } else {
            statusElement.innerHTML = '<span class="status fail">Issues detected</span>';
            log('‚ö†Ô∏è Some tests failed. Check individual results above.', 'warning', 'fixResults');
        }
    }

    // Auto-run diagnostic on load
    window.addEventListener('load', function() {
        setTimeout(runFullDiagnostic, 1000);
    });
</script>
</body>
</html>